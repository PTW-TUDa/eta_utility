# Setup pip cache so that it can be reused between jobs
variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.pip_cache"
  GIT_CLEAN_FLAGS: -x -f -e .pip_cache/** -e venv/**

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: ($CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH || $CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "development")
    - if: $CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS
      when: never

include:
  - template: Security/Secret-Detection.gitlab-ci.yml
  - template: Security/License-Scanning.gitlab-ci.yml

stages:
  - setup
  - check
  - test
  - deploy

cache: &global_cache
  key: $CI_COMMIT_REF_SLUG
  paths:
    - .pip_cache
    - venv
  policy: pull-push

default:
  tags:
    - python
    - docker

  image: python:3.7

  before_script:
    - python -V  # Print out python version for debugging
    - python3 -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
    - pip install .[develop]

create_cache:
  stage: setup
  interruptible: true
  before_script:
    - echo ""
  script:
    - rm -rf venv .venv .cache .pytest_cache .mypy_cache dist doc eta_utility.egg-info build
    - ls -la
    - python -V
    - python3 -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
    - pip install .[develop]
    - pip install flake8-json

isort:
  stage: check
  interruptible: true
  script:
    - pip install isort
    - isort -c -v .
  cache:
    <<: *global_cache
    policy: pull

black:
  stage: check
  interruptible: true
  script:
    - pip install black
    - black --check --config pyproject.toml eta_utility/ test/
  cache: []

flake8:
  stage: check
  interruptible: true
  script:
    - pip install flake8-json
    - flake8 --version
    - flake8 --config=setup.cfg --format=codeclimate --tee --output-file=flake8.json eta_utility test
  artifacts:
    reports:
      codequality: flake8.json
  cache:
    <<: *global_cache
    policy: pull

license_scanning:
  stage: check
  interruptible: true
  needs: []
  before_script: []
  variables:
    ASDF_PYTHON_VERSION: 3
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: ($CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH || $CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "development")
    - if: $CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS
      when: never
  cache:
    <<: *global_cache
    policy: pull

secret_detection:
  stage: check
  interruptible: true
  before_script: []
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: ($CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH || $CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "development")
    - if: $CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS
      when: never
  cache:
    <<: *global_cache
    policy: pull

test:
  stage: test
  interruptible: true
  script:
    - pip install pytest pytest-cov
    - pytest --cov
  cache:
    <<: *global_cache
    policy: pull

typecheck:
  stage: test
  interruptible: true
  script:
    - mypy -V
    - mypy --config-file pyproject.toml
  cache:
    <<: *global_cache
    policy: pull

# build the sources
build:
  stage: deploy
  script:
    - rm -rf dist/
    - pip install build twine
    - python -m build --sdist --wheel
    - TWINE_PASSWORD=${CI_JOB_TOKEN} TWINE_USERNAME=gitlab-ci-token python -m twine upload --verbose --repository-url https://$CI_SERVER_HOST/api/v4/projects/$CI_PROJECT_ID/packages/pypi dist/*
  artifacts:
    name: "eta_utility-build-$CI_COMMIT_REF_NAME-$CI_JOB_STATUS"
    paths:
      - dist/
      - eta_utility.egg-info/
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
      when: always
  cache:
    <<: *global_cache
    policy: pull

# Create sphinx html documentation
pages:
  stage: deploy
  script:
    - apt-get update
    - apt-get --yes install libgl1-mesa-glx
    - pip install sphinx sphinx-rtd-theme
    - cd docs
    - make html
    - rm -rf ../public/html/*
    - mv _build/html ../public
  artifacts:
    name: "eta_utility-docs-$CI_COMMIT_REF_NAME"
    paths:
      - public/
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
  cache:
    <<: *global_cache
    policy: pull

compile_fmu:
  stage: setup
  before_script:
    - echo ""
  script:
    - python -V  # Print out python version for debugging
    - python3 -m venv venv
    - source venv/bin/activate
    - pip install fmpy
    - apt-get update
    - apt-get --yes install zip
    - \[ ! -d $CI_PROJECT_DIR/fmu_extract ] && mkdir $CI_PROJECT_DIR/fmu_extract
    - unzip -u $CI_PROJECT_DIR/test/test_resources/test_fmu.fmu -d fmu_extract
    - cd fmu_extract/sources
    - gcc -c -I. -I$CI_PROJECT_DIR/venv/lib/python3.7/site-packages/fmpy/c-code -fPIC all.c && gcc -static-libgcc -shared -oout.so *.o
    - \[ ! -d ../binaries/linux64 ] && mkdir ../binaries/linux64
    - mv out.so ../binaries/linux64/test_fmu.so
    - cd ..
    - zip -r ../test_fmu.fmu *
    - cd ..
    - rm -rf fmu_extract
  rules:
    - when: never
  cache: []
